<aura:component controller="Opportunity_ClosingProcess" implements="forceCommunity:availableForAllPageTypes,flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId" access="global">
    <lightning:overlayLibrary aura:id="overlayLib"/>
    
    <!--File upload attributes-->
    <aura:attribute name="filetype" type="List" default="['.png', '.jpg', '.jpeg', '.pdf']" />
    <aura:attribute name="multiple" type="Boolean" default="true" />
    <aura:attribute name="disabled" type="Boolean" default="true" />
    <aura:attribute name="recordId" type="Id" />
    <!--File upload attributes-->
    
    <aura:attribute name="errMsg" type="String" default="" />
    <aura:attribute name="showSpinner" type="Boolean" default="false"/>
    <aura:attribute name="isClosedLost" type="Boolean" default="false"/>
    <aura:attribute name="isClosedWon" type="Boolean" default="false"/>
    <aura:attribute name="isPrioritySO" type="String" default="null" />
    <aura:attribute name="oppData" type="Opportunity" default=""/>
    <aura:attribute name="isModalOpen" type="Boolean" default="false"/>
    <aura:attribute name="confetti" type="Boolean" default="false"/>
    <aura:attribute name="closedFields" type="Object"/>
    <aura:attribute name="variant" type="String" default="non-linear"/>
    <aura:attribute name="hideUpdateButton" type="Boolean" default="false"/>
    <aura:attribute name="hideStagePathUpdateBtn" type="Boolean" default="false"/>
    <aura:attribute name="innerPathValue" type="String"/>
    <aura:attribute name="showWhatSigned" type="Boolean" default="false"/>
    <aura:attribute name="showHandover" type="boolean" default="false"/>
    <aura:attribute name="record" type="Object"/>
    <aura:attribute name="recordSaveError" type="String"/>
    <aura:attribute name="showValidation" type="Boolean" default="true"/>
    <aura:attribute name="isSoManuallySigned" type="Boolean" default="false"/>
    <aura:attribute name="wonCompletedSuccess" type="Boolean" default="false"/>
    <aura:attribute name="checkARR" type="boolean" default="false"/>
    <aura:attribute name="greenBucketData" type="Opportunity" default=""/>

    <!--Field Sets attributes-->
    <aura:attribute name="internalOppLost_NotExpansion" type="List"/>
    <aura:attribute name="internalOppLWon_Expansion" type="List"/>
    <aura:attribute name="internalOppLWon_NotExpansion" type="List"/>
    <aura:attribute name="partnerOppLWonLost_Expansion" type="List"/>
    <aura:attribute name="fields" type="List" default="[]" />
    
    <lightning:quickActionAPI aura:id="quickActionAPI" />
    <lightning:notificationsLibrary aura:id="notifLib"/>

    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
    
    <force:recordData aura:id="recordEditor"
        layoutType="FULL"
        fields="StageName,Probability,Is_SO_Signed__c,DH_Date_of_Signature__c,DH_Signer_Name_c__c,DH_Signer_Email__c,DH_Signer_Title__c,Manual_Signature_Reason__c,Lost_Reason__c,Which_competitor__c,Which_features_were_missing__c,What_Would_You_Like_To_Claim__c,Close_Process_Path__c"
        recordId="{!v.recordId}"
        targetRecord="{!v.record}"
        targetFields="{!v.closedFields}"
        recordUpdated="{!c.recordUpdated}"
        mode="EDIT"/>

    <aura:if isTrue="{!v.showSpinner}">
        <div role="status" class="slds-spinner slds-spinner_large slds-spinner_brand">
            <span class="slds-assistive-text">Loading</span>
            <div class="slds-spinner__dot-a"></div>
            <div class="slds-spinner__dot-b"></div>
        </div>
    </aura:if>

    <!-- If the Stage is already Closed or an open stage was selected - we display the path with update button
        else we display the picklis path without update button to select closed won/lost-->
    <aura:if isTrue="{!!v.hideStagePathUpdateBtn}"> <!-- hideStagePathUpdateBtn = FALSE -->
        <lightning:path aura:id="path" recordId="{!v.recordId}" variant="linear" hideUpdateButton="{!v.hideStagePathUpdateBtn}" onselect="{!c.handleStageSelected}"/>
        <aura:set attribute="else"> <!-- hideStagePathUpdateBtn = TRUE -->
            <lightning:picklistPath aura:id="picklistPath" recordId="{!v.recordId}" variant="linear" picklistFieldApiName="StageName" onselect="{!c.handleClosedStageSelected}"/>
        </aura:set>
    </aura:if>

    <aura:if isTrue="{!v.isModalOpen}">
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-modal_small slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <lightning:buttonIcon iconName="utility:close"
                                          onclick="{! c.closeModal }"
                                          alternativeText="close"
                                          variant="bare-inverse"
                                          class="slds-modal__close"/>
                    <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Close Opportunity Process</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                    <aura:if isTrue="{!v.isClosedLost}">
                        <lightning:progressIndicator currentStep="{!v.innerPathValue}" type="path" variant="base">
                            <aura:if isTrue="{!v.innerPathValue != 'continueToSummary'}">
                                <lightning:progressStep label="Lost Information" value="LostInfo"/>
                                <aura:if isTrue="{!greaterthanorequal(v.oppData.Green_Bucket_ARR_V2__c, 10000)}">
                                    <lightning:progressStep label="Opportunity Summary" value="OppSummary"/>
                                </aura:if>
                            </aura:if>
                        </lightning:progressIndicator>
                        <aura:if isTrue="{!v.innerPathValue == 'LostInfo'}">
                            <lightning:card>
                                <aura:if isTrue="{!!v.showValidation}">
                                    <lightning:recordEditForm 
                                        recordId="{!v.recordId}"
                                        objectApiName="Opportunity"
                                        aura:id="closedLostFields">
                                        <lightning:messages aura:id="lostMessage"/>                                        
                                        <lightning:inputField aura:id="ClosedLostFieldCheck" fieldName="StageName" required="true" value="Closed Lost" disabled="true"/>
                                        <lightning:inputField aura:id="ClosedLostFieldCheck" fieldName="Lost_Reason__c" value="{!v.closedFields.Lost_Reason__c}" required="true"/>
                                        <lightning:inputField aura:id="ClosedLostFieldCheck" fieldName="Which_competitor__c" value="{!v.closedFields.Which_competitor__c}" required="true"/>
                                        <lightning:inputField aura:id="ClosedLostFieldCheck" fieldName="Which_features_were_missing__c" value="{!v.closedFields.Which_features_were_missing__c}" required="true"/>
                                    </lightning:recordEditForm>
                                </aura:if>
                                <aura:if isTrue="{!v.showValidation}">
                                    <div class="slds-text-heading_small ">Please fill the following fields in order to Close Lost this opportunity</div>
                                    <lightning:recordEditForm
                                            onsubmit="{!handleSubmitValidation_Lost}"
                                            onsuccess="{!c.handleSuccessFieldSets}"
                                            onerror="{!c.turnOffSpinner}"
                                            recordId="{!v.recordId}"
                                            objectApiName="Opportunity"
                                            aura:id="validationLostFields">
                                        <lightning:messages/>                                        
                                        <aura:iteration items="{!v.fields}" var="field" indexVar="i">
                                            <div class="slds-grid slds-gutters">
                                                <div class="slds-col slds-size_1-of-1">
                                                    <lightning:inputField rendered="" variant="label-stacked" required="{!field.required}" fieldName="{!field.fieldPath}"/>
                                                </div>
                                            </div>
                                        </aura:iteration>
                                        <div class="slds-align_absolute-center">
                                            <lightning:button variant="brand" label="Submit" type="submit"/>
                                        </div>
                                    </lightning:recordEditForm>
                                </aura:if>
                            </lightning:card>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'OppSummary'}">
                            <lightning:flow aura:id="closedOppSumFlowData" onstatuschange="{!c.handleStatusChange_OpportunityCloseSummary}"/>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'continueToSummary'}">
                            <lightning:card>
                                <div style="text-align: center">
                                    <ui:message title="You've finished the Closed Lost Process" severity="confirm" closable="true">
                                        <br/>
                                        If you want to fill the Opportunity Summary<br/>
                                        Click <b>Next Step</b> button<br/><br/>
                                        If you want to SKIP the Opportunity Summary<br/>
                                        Click <b>Finish</b> button<br/>
                                    </ui:message>
                                </div>
                            </lightning:card>
                        </aura:if>
                    </aura:if>
                    <aura:if isTrue="{!v.isClosedWon}">
                        <aura:if isTrue="{!v.innerPathValue != 'continueToSummary'}">
                            <lightning:progressIndicator currentStep="{!v.innerPathValue}" type="path" variant="base">
                                <aura:if isTrue="{!v.oppData.Is_Primary_SO_Signed__c}">
                                    <lightning:progressStep label="SO Information" value="SOInfo"/>
                                </aura:if>
                                <aura:if isTrue="{!and(!v.oppData.Is_Primary_SO_Signed__c, v.innerPathValue != 'continueToSummary')}">
                                    <lightning:progressStep label="Claim" value="Claim"/>
                                </aura:if>
                                <aura:if isTrue="{!!v.oppData.Is_Primary_SO_Signed__c}">
                                    <aura:if isTrue="{!v.closedFields.What_Would_You_Like_To_Claim__c == 'Sales Order ARR + CC Payments'}">
                                        <lightning:progressStep label="Manual Signature" value="ManualSignature"/>
                                    </aura:if>
                                    <aura:if isTrue="{!v.closedFields.What_Would_You_Like_To_Claim__c == 'Sales Order ARR'}">
                                        <lightning:progressStep label="Manual Signature" value="ManualSignature"/>
                                    </aura:if>
                                </aura:if>
                                <lightning:progressStep label="CC Claim" value="CCClaim"/>
                                <aura:if isTrue="{!and(v.oppData.RecordType.Name == 'Internal Opportunity', v.showHandover == true)}">
                                    <lightning:progressStep label="Handover" value="Handover"/>
                                </aura:if>
                                <aura:if isTrue="{!or(greaterthanorequal(v.oppData.Green_Bucket_ARR_V2__c, 10000), v.innerPathValue == 'OppSummary')}">
                                    <lightning:progressStep label="Opportunity Summary" value="OppSummary"/>
                                </aura:if>
                            </lightning:progressIndicator>
                        </aura:if>                        
                        <aura:if isTrue="{!v.innerPathValue != 'continueToSummary'}">
                            <lightning:card>
                                <lightning:accordion allowMultipleSectionsOpen="true">
                                    <lightning:accordionSection name="A" label="Need Help?">
                                        <aura:set attribute="body">
                                            <div class="slds-box slds-box_xx-small">
                                                <aura:if isTrue="{!and(!v.oppData.Is_Primary_SO_Signed__c, v.closedFields.What_Would_You_Like_To_Claim__c != 'CC Payments')}">
                                                    <aura:if isTrue="{!v.closedFields.What_Would_You_Like_To_Claim__c != undefined}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="Missing" size="12">
                                                                You Claimed: <b>{!v.closedFields.What_Would_You_Like_To_Claim__c}</b>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.innerPathValue == 'Claim'}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                You don't have Signed SO <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            You need to review/update the following:
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Manual Signature fields
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>If Prioity SO - choose from BigBrain Pickers
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>CC Claim
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <aura:if isTrue="{!v.showHandover == true}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Create Handover
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.showHandover == false}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                No Handover to create
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.oppData.Green_Bucket_ARR_V2__c >= 10000}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Optional: Update the Opportunity Summary
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!lessthan(v.oppData.Green_Bucket_ARR_V2__c, 10000)}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                Your Green Bucket ARR is <b>less than 10k</b>, no need to create an Opportunity Summary
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                </aura:if>
                    
                                                <aura:if isTrue="{!and(!v.oppData.Is_Primary_SO_Signed__c, v.closedFields.What_Would_You_Like_To_Claim__c == 'CC Payments')}">
                                                    <aura:if isTrue="{!v.closedFields.What_Would_You_Like_To_Claim__c != undefined}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="Missing" size="12">
                                                                You Claimed: <b>{!v.closedFields.What_Would_You_Like_To_Claim__c}</b>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.closedFields.Close_Process_Path__c == 'Claim'}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                You don't have Signed SO <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            You need to review/update the following:
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>CC Claim
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <aura:if isTrue="{!v.showHandover == true}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Create Handover
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.showHandover == false}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                No Handover to create
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.oppData.Green_Bucket_ARR_V2__c >= 10000}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Optional: Update the Opportunity Summary
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!lessthan(v.oppData.Green_Bucket_ARR_V2__c, 10000)}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                Your Green Bucket ARR is <b>less than 10k</b>, no need to create an Opportunity Summary
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                </aura:if>
                    
                                                <aura:if isTrue="{!v.oppData.Is_Primary_SO_Signed__c}">
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>You have Signed SO <br/>
                                                            You need to review/update the following:
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Review SO Information
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <lightning:layout>
                                                        <lightning:layoutItem title="" size="12">
                                                            <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>CC Claim
                                                        </lightning:layoutItem>
                                                    </lightning:layout>
                                                    <aura:if isTrue="{!v.showHandover == true}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Create Handover
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.showHandover == false}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                No Handover to create
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!v.oppData.Green_Bucket_ARR_V2__c >= 10000}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <span><lightning:icon iconName="utility:check" variant="success" size="xx-small" /></span>Optional: Update the Opportunity Summary
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                    <aura:if isTrue="{!lessthan(v.oppData.Green_Bucket_ARR_V2__c, 10000)}">
                                                        <lightning:layout>
                                                            <lightning:layoutItem title="" size="12">
                                                                <br/>
                                                                Your Green Bucket is less than 10k, no need to create an Opportunity Summary
                                                                <br/>
                                                            </lightning:layoutItem>
                                                        </lightning:layout>
                                                    </aura:if>
                                                </aura:if>
                                            </div>
                                        </aura:set>
                                    </lightning:accordionSection>
                                </lightning:accordion>
                            </lightning:card>
                        </aura:if>
                        <aura:if isTrue="{!and(v.oppData.Is_Primary_SO_Signed__c, v.innerPathValue == 'SOInfo')}">
                            <aura:if isTrue="{!!v.showSpinner}">
                                <lightning:card>
                                    <aura:if isTrue="{!!v.showValidation}">
                                        <lightning:recordEditForm 
                                            recordId="{!v.recordId}"
                                            objectApiName="Opportunity">
                                        <lightning:messages/>
                                        <lightning:outputField iconName="quotes" fieldName="SyncedQuoteId"/>
                                        </lightning:recordEditForm>
                                        
                                        <lightning:input label="DH Tier" value="{!v.oppData.SyncedQuote.DH_Tier__c}" disabled="true"/>
                                        <lightning:input label="Total Seats" value="{!v.oppData.SyncedQuote.Total_Seats__c}" disabled="true"/>
                                        <lightning:input label="DH Period" value="{!v.oppData.SyncedQuote.DH_Period__c}" disabled="true"/>
                                    </aura:if>
                                    
                                    <aura:if isTrue="{!v.showValidation}">
                                        <lightning:recordEditForm
                                            onsubmit="{!c.handleSubmitValidation_SOWon}"
                                            onsuccess="{!c.handleSuccessFieldSets}"
                                            onerror="{!c.turnOffSpinner}"
                                            recordId="{!v.recordId}"
                                            aura:id="validationSOFields"
                                            objectApiName="Opportunity">
                                            <lightning:messages/>
                                            <ui:message title="Key Information:" severity="info">
                                                Please make sure you populate all the following fields before closing the Opp.<br/>
                                            </ui:message>
                                            <aura:iteration items="{!v.fields}" var="field" indexVar="i">
                                                <div class="slds-grid slds-gutters">
                                                    <div class="slds-col slds-size_1-of-1">
                                                        <lightning:inputField rendered="" variant="label-stacked" required="{!field.required}" fieldName="{!field.fieldPath}"/>
                                                    </div>
                                                </div>
                                            </aura:iteration>
                                            <lightning:inputField aura:id="companySize" rendered="" variant="label-stacked" fieldName="Company_Size__c" value="{!v.oppData.Company_Employees__c}" required="true"/>
                                            <div class="slds-align_absolute-center">
                                                <lightning:button variant="brand" label="Submit" type="submit"/>
                                            </div>
                                        </lightning:recordEditForm>
                                    </aura:if>
                                </lightning:card>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'Claim'}">
                            
                            <aura:if isTrue="{!!v.showSpinner}">
                                <lightning:card>
                                    <aura:if isTrue="{!!v.showValidation}">
                                        <div class="slds-box slds-box_xx-small">
                                            <c:opportunity_ClaimDetails recordId="{!v.recordId}"/>
                                        </div>
                                        <div>
                                            <lightning:recordEditForm
                                                recordId="{!v.recordId}"
                                                objectApiName="Opportunity"
                                                aura:id="closedWonFields">
                                                <lightning:messages aura:id="claimMessage"/>
        
                                                <lightning:inputField aura:id="newOpportunityClaimField" fieldName="What_Would_You_Like_To_Claim__c" value="{!v.closedFields.What_Would_You_Like_To_Claim__c}" onchange="{!c.setWhatWouldYouLikeToClaim}" required="true"/>
                                            </lightning:recordEditForm>
                                        </div>
                                    </aura:if>
                                    <aura:if isTrue="{!v.showValidation}">
                                        <lightning:recordEditForm
                                            onsubmit="{!c.handleSubmitValidation_ClaimWon}"
                                            onsuccess="{!c.handleSuccessFieldSets}"
                                            onerror="{!c.turnOffSpinner}"
                                            recordId="{!v.recordId}"
                                            objectApiName="Opportunity"
                                            aura:id="validationClaimFields">
                                            <lightning:messages/>
                                            
                                            <ui:message title="Key Information:" severity="info">
                                                Please make sure you populate all the following fields before closing the Opp.<br/>
                                            </ui:message>
                                            <aura:iteration items="{!v.fields}" var="field" indexVar="i">
                                                <div class="slds-grid slds-gutters">
                                                    <div class="slds-col slds-size_1-of-1">
                                                        <lightning:inputField rendered="" variant="label-stacked" required="{!field.required}" fieldName="{!field.fieldPath}"/>
                                                    </div>
                                                </div>
                                            </aura:iteration>
                                            <lightning:inputField aura:id="companySize" rendered="" variant="label-stacked" fieldName="Company_Size__c" value="{!v.oppData.Company_Employees__c}" required="true"/>
                                            <div class="slds-align_absolute-center">
                                                <lightning:button variant="brand" label="Submit" type="submit"/>
                                            </div>
                                        </lightning:recordEditForm>
                                    </aura:if>
                                </lightning:card>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'ManualSignature'}">
                            <aura:if isTrue="{!!v.showSpinner}">
                                <lightning:card>
                                <lightning:recordEditForm
                                        onsubmit="{!v.submitDetails}"
                                        recordId="{!v.recordId}"
                                        objectApiName="Opportunity"
                                        aura:id="closedFields">
                                    <lightning:messages aura:id="oppMessage"/>                                    
                                    <lightning:input aura:id="manuallySignedFields" type="checkbox" label="Is SO Manually Signed?" checked="{!v.closedFields.Is_SO_Signed__c}" value="{!v.closedFields.Is_SO_Signed__c}" required="true" onchange="{!c.isSOManuallySignedClicked}"/>
                                    <lightning:inputField aura:id="manuallySignedFields" fieldName="DH_Date_of_Signature__c" value="{!v.closedFields.DH_Date_of_Signature__c}" required="true" />
                                    <lightning:inputField aura:id="manuallySignedFields" fieldName="DH_Signer_Name_c__c" value="{!v.closedFields.DH_Signer_Name_c__c}" required="true"/>
                                    <lightning:inputField aura:id="manuallySignedFields" fieldName="DH_Signer_Email__c" value="{!v.closedFields.DH_Signer_Email__c}" required="true"/>
                                    <lightning:inputField aura:id="manuallySignedFields" fieldName="DH_Signer_Title__c" value="{!v.closedFields.DH_Signer_Title__c}" required="true"/>
                                    <lightning:inputField aura:id="manuallySignedFields" fieldName="Manual_Signature_Reason__c" value="{!v.closedFields.Manual_Signature_Reason__c}" required="true" onchange="{!c.prioritySO}"/>
                                    <c:fileUploadImproved aura:id="fileUploadImp"
                                        label="Attachment"
                                        acceptedFormats="{!v.filetype}"
                                        allowMultiple="false"
                                        sessionKey="{!v.recordId}"
                                        recordId="{!v.recordId}"
                                        required="true"
                                        maxAllowed="1"
                                        multiple="false"
                                        filenameSuffix="-signed"
                                    ></c:fileUploadImproved>
                                </lightning:recordEditForm>
                            </lightning:card>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'CCClaim'}">
                            
                            <aura:if isTrue="{!!v.showSpinner}">
                                <lightning:card>
                                    <c:subscriptionPickersComponent recordId="{!v.recordId}"/>
                                </lightning:card>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'continueToSummary'}">
                            
                            <aura:if isTrue="{!greaterthanorequal(v.greenBucketData.Green_Bucket_ARR_V2__c, 10000)}">
                                <lightning:card>
                                    <div style="text-align: center">
                                        <ui:message title="Congrats!! You've finished the Closed Won Process :)" severity="confirm" closable="true">
                                            <br/>
                                            If you want to fill the Opporutnity Summary<br/>
                                            Click <b>Next Step</b> button<br/><br/>
                                            If you want to SKIP the Opporutnity Summary<br/>
                                            Click <b>Finish</b> button<br/>
                                        </ui:message>
                                    </div>
                                </lightning:card>
                            </aura:if>
                            <aura:if isTrue="{!lessthan(v.greenBucketData.Green_Bucket_ARR_V2__c, 10000)}">
                                <lightning:card>
                                    <div style="text-align: center">
                                        <ui:message title="Congrats!! You've finished the Closed Won Process :)" severity="confirm" closable="true">
                                            <br/>
                                            To finish the process,<br/>
                                            Click <b>Finish</b> button<br/>
                                        </ui:message>
                                    </div>
                                </lightning:card>
                            </aura:if>
                        </aura:if>
                        <aura:if isTrue="{!v.innerPathValue == 'Handover'}">
                            <lightning:flow aura:id="handoverFlowData" onstatuschange="{!c.handleStatusChange_Handover}"/>
                        </aura:if>
                        <aura:if isTrue="{!or(v.innerPathValue == 'OppSummary', v.closedFields.Close_Process_Path__c == 'Opportunity Summary')}">
                            <lightning:flow aura:id="closedOppSumFlowData" onstatuschange="{!c.handleStatusChange_OpportunityCloseSummary}"/>
                        </aura:if>
                    </aura:if>

                    <aura:if isTrue="{!not(v.errMsg=='')}">
                        <div class="slds-text-heading_small slds-text-align_center slds-text-color_error">{!v.errMsg}</div>
                    </aura:if>
                </div>
                <aura:if isTrue="{!and(v.innerPathValue != 'continueToSummary', !v.showValidation)}">
                    <aura:if isTrue="{!and(v.innerPathValue != 'OppSummary', v.innerPathValue != 'Handover')}">
                        <footer class="slds-modal__footer">
                            <lightning:button variant="neutral"
                                              label="Cancel"
                                              title="Cancel"
                                              onclick="{! c.closeModal }"/>
                            <aura:if isTrue="{!v.innerPathValue != 'LostInfo'}">
                                <lightning:button variant="neutral"
                                label="Previous"
                                title="Previous"
                                onclick="{!c.previousStep}"/>
                            </aura:if>
                            <lightning:button variant="brand"
                                                label="Next Step"
                                                title="Next Step"
                                                onclick="{!c.submitDetails}"/>
                        </footer>
                    </aura:if>
                    <aura:if isTrue="{!v.innerPathValue == 'OppSummary'}">
                        <footer class="slds-modal__footer">
                            <lightning:button variant="neutral"
                                              label="Cancel"
                                              title="Cancel"
                                              onclick="{! c.closeModal }"/>
                        </footer>
                    </aura:if>
                </aura:if>
                <aura:if isTrue="{!v.innerPathValue == 'continueToSummary'}">
                    <aura:if isTrue="{!or(greaterthanorequal(v.greenBucketData.Green_Bucket_ARR_V2__c, 10000), v.closedFields.StageName == 'Closed Lost')}">
                        <footer class="slds-modal__footer">
                            <lightning:button variant="brand"
                                              label="Finish"
                                              title="Finish"
                                              onclick="{! c.closeModal }"/>
                            <lightning:button variant="neutral"
                                              label="Next Step"
                                              title="Next Step"
                                              onclick="{!c.submitDetails}"/>
                        </footer>
                    </aura:if>
                    <aura:if isTrue="{!and(lessthan(v.greenBucketData.Green_Bucket_ARR_V2__c, 10000), v.closedFields.StageName == 'Closed Won')}">
                        <footer class="slds-modal__footer">
                            <lightning:button variant="brand"
                                              label="Finish"
                                              title="Finish"
                                              onclick="{! c.closeModal }"/>
                        </footer>
                    </aura:if>
                </aura:if>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    <aura:if isTrue="{!!v.isModalOpen}">
        <aura:if isTrue="{!v.confetti == true}">
            <c:FlowConfettiCMP/>
        </aura:if>
    </aura:if>
</aura:component>