public with sharing class BigBrainAPI {
    public class BigBrainException extends Exception {}

    public BigBrainAPI() { }

    public static String getAccountProfile(String pulseAccountId){
        return get('/salesforce_api/account/' + pulseAccountId);
    }
    
    public static String getAccountUsers(String pulseAccountId){
        return get('/salesforce_api/account/' + pulseAccountId + '/users');
    }

    public static String getAccountBilling(String pulseAccountId){
        return get('/salesforce_api/account/' + pulseAccountId + '/billing');
    }

    public static String getAccountFeaturesUsage(String pulseAccountId){
        return get('/salesforce_api/account/' + pulseAccountId + '/features_usage');
    }

    public static String getForecastDetails(String pulseAccountId){
        return get('/salesforce_api/account/' + pulseAccountId + '/forecast_details');
    }

    public static String getPlans(String pricingVersion){
        return get('/salesforce_api/plans/' + pricingVersion);
    }
    
    public static String getAllGrantedFeatures(String pulseAccountId){
        // return get('/exposed_partners/get_features_of_all_plans/' + pulseAccountId);
        return '{"standard":["advanced_board_filters","conditional_formatting_settings","api","automations","basic_usage_stats","cross_board","files_search","integrations","google_calendar_integration","personal_api","share_boards","storage_stats","tidy_up","timeline","guests","board_templates","activity_log_filters","activity_log_tracking_unlimited","form_customization","request_a_callback","button_column_type","subtasks_column_type","dropdown_column_type","integration_column_type","group_column_type","multiple_person_column_type","email_column_type","lookup_column_type","board_relation_column_type","file_column_type","name_column_type","hour_column_type","text_column_type","person_column_type","color_column_type","numeric_column_type","color_picker_column_type","timerange_column_type","date_column_type","brauer_column_type","pulse_log_column_type","pulse_updated_column_type","timezone_column_type","country_column_type","location_column_type","pulse_id_column_type","link_column_type","columns_battery_column_type","week_column_type","votes_column_type","long_text_column_type","custom_url_column_type","action_column_type","rating_column_type","boolean_column_type","autonumber_column_type","phone_column_type","team_column_type","form_board_view","calendar_board_view","files_board_view","kanban_board_view","gallery_card_view","map_board_view","spp_board_view","timeline_board_view","timeline_gantt_board_view","app_feature_board_view","app_feature_item_view","table_board_view","layout_container_item_view","deadline_date_status_combo_type","deadline_timeline_status_combo_type"],"pro":["advanced_usage_stats","google_authentication","hide_brand_on_forms","private_boards","tags","unlimited_guests","custom_fields","new_advanced_usage_stats","board_advanced_permission_lock_column","board_advanced_permission_hide_column","board_advanced_permission_assignee","milestones","baseline","dependency_column_type","formula_column_type","duration_column_type","graph_board_view","resource_allocation_board_view","portfolio_overview_section"],"enterprise":["advanced_security","audit","higher_api_rate","saml_authentication","scim_provisioning","invite_blocked_domains","session_duration_config","session_management","account_permissions","workspaces","workspaces_full","account_homepage_entity","column_templates","schedule_overview_email","admin_insights","admin_setting_disable_welcome_email","ip_restrictions","workspace_permissions","hipaa_compliance_activation"],"others":["embedded_item_view","grid_recycler","automations_mirror_columns_support","prevent_posts_aggregation","alpha_addicts","prevent_timeline_name_cutoff","prevent_timeline_sticky_name","prevent_user_guidance","unlimited_storage","mobile_bug_reporting","automations_beta_recipes","board_temp_translation","ignore_unsupported_browser_message","pulse_page_with_values","asana_beta_import","floating_boards_ownership","export_board_to_excel_async","export_to_excel_hide_powered_by_monday","prevent_done_holiday_animation","prevent_done_animation","widget_excel_link","date_picker_enable_week_number","exclude_from_ab_tests","conditional_formatting_settings_release","allow_group_column","board_rule_based_filtering","board_header_v2","overview_section_extra_boards","overview_section_extra_enterprise_boards","disable_inbox_cards","import_from_xls_higher_limit","fs_bugs_recording","unlimited_daily_invites","prevent_failed_login_admins_email","shorter_session_timeouts","prevent_notifications_loop","new_first_board_creation_options","prevent_email_update","prevent_quick_filter_counters","unified_boards_list_show_only_my_empty_folders","duplicate_boards_between_accounts","prevent_advanced_stats","guest_allow_same_auth_domain","guest_block_same_auth_domain","monday_board_and_admin_cross_account","monday_apps_use","share_views","prevent_share_views","favorites_folders","done_party","file_versioning","block_non_admin_guests_invite","automations_beta_app_salesforce","automations_beta_app_jiraOnPremise","leftpane_alphabetical_sort","performance_measurements","always_prevent_plan_enforcer","multi_board_linked_items","multi_board_linkage","undo_move_items","board_toolbar_compact_menu","google_drive_limited_scope","disable_end_of_year_feature_2020","collapsed_group_footers","board_footers","move_to_paypal","prevent_automations_assign_notifications","multiple_status_battery","force_paypal_confirmation","new_prices","new_rounded_prices","prorated_seats_upgrade","prorated_upgrade_via_ui","application_themes","countdown_widget_with_board_data","board_conference_video","hide_zoom_button","hide_integrations_button_logos","my_focus","create_new_saml_users_as_viewers","monday_restricted_apps","mobile_payment","board_subset_many_columns_fix","support_sub_items_in_dashboards","invite_with_credits","freeze_short_interval","item_views","timeline_right_click_menu","workload_horizontal_workflow","monday_app_296","monday_app_567","monday_app_482","monday_app_552","duplicate_integrations","monday_solutions_tab","solutions_onboarding_tab","solutions_sharing_tab","workspaces_dropdown_navigation","workspaces_dropdown_navigation_without_pane","allow_non_admin_store_app_install","activity_log_new_jwt","disable_info_box","enable_info_box","clusters_for_locale","end_of_year_feature_2020_share_disable","increase_board_items_max_board_items_count_graphql","increase_column_limits_by_100","increase_column_limits_by_200","increase_row_limits_by_10k","increase_row_limits_by_20k","custom_recipes_increased_max_actions","hide_user_management_last_active","my_monday_mobile","disable_new_pdf_reader","disable_request_app_install","show_homepage_desktop","block_billing_ability","disable_hover_thumbnail_for_external_files_services","trial_unlimited_actions","salesforce_standard_entities_polling","gmail_integration_block","outlook_integration_block","regenerate_tokens","object_app_feature","end_of_year_feature","bolt_switch_in_boards_list","indexed_db_api_cache_edge_electron","unlimited_free_users_modal","sync_to_column_values_ms","integrity_column_values_from_ms"]}';
    }

    public static String getAccountUsedGrantedFeatures(String pulseAccountId){
        return '{"status":"success","features":{"advanced_board_filters":{"has_feature":true,"type":"plan"},"conditional_formatting_settings":{"has_feature":true,"type":"plan"},"advanced_security":{"has_feature":true,"type":"plan"},"advanced_usage_stats":{"has_feature":true,"type":"plan"},"api":{"has_feature":true,"type":"plan"},"automations":{"has_feature":true,"type":"plan"},"basic_usage_stats":{"has_feature":true,"type":"plan"},"audit":{"has_feature":true,"type":"plan"},"cross_board":{"has_feature":true,"type":"plan"},"files_search":{"has_feature":true,"type":"plan"},"google_authentication":{"has_feature":true,"type":"plan"},"higher_api_rate":{"has_feature":true,"type":"plan"},"hide_brand_on_forms":{"has_feature":true,"type":"plan"},"integrations":{"has_feature":true,"type":"plan"},"google_calendar_integration":{"has_feature":true,"type":"plan"},"personal_api":{"has_feature":true,"type":"plan"},"private_boards":{"has_feature":true,"type":"plan"},"saml_authentication":{"has_feature":true,"type":"plan"},"scim_provisioning":{"has_feature":true,"type":"plan"},"invite_blocked_domains":{"has_feature":true,"type":"plan"},"share_boards":{"has_feature":true,"type":"plan"},"tags":{"has_feature":true,"type":"plan"},"storage_stats":{"has_feature":true,"type":"plan"},"tidy_up":{"has_feature":true,"type":"plan"},"timeline":{"has_feature":true,"type":"plan"},"guests":{"has_feature":true,"type":"plan"},"unlimited_guests":{"has_feature":true,"type":"plan"},"custom_fields":{"has_feature":true,"type":"plan"},"session_duration_config":{"has_feature":true,"type":"plan"},"board_templates":{"has_feature":true,"type":"plan"},"activity_log_filters":{"has_feature":true,"type":"plan"},"activity_log_tracking_unlimited":{"has_feature":true,"type":"plan"},"session_management":{"has_feature":true,"type":"plan"},"form_customization":{"has_feature":true,"type":"plan"},"new_advanced_usage_stats":{"has_feature":true,"type":"plan"},"board_advanced_permission_lock_column":{"has_feature":true,"type":"plan"},"board_advanced_permission_hide_column":{"has_feature":true,"type":"plan"},"board_advanced_permission_assignee":{"has_feature":true,"type":"plan"},"account_permissions":{"has_feature":true,"type":"plan"},"workspaces":{"has_feature":true,"type":"plan"},"workspaces_full":{"has_feature":true,"type":"plan"},"account_homepage_entity":{"has_feature":true,"type":"plan"},"column_templates":{"has_feature":true,"type":"plan"},"request_a_callback":{"has_feature":true,"type":"plan"},"schedule_overview_email":{"has_feature":true,"type":"plan"},"milestones":{"has_feature":true,"type":"plan"},"admin_insights":{"has_feature":true,"type":"plan"},"admin_setting_disable_welcome_email":{"has_feature":true,"type":"plan"},"ip_restrictions":{"has_feature":true,"type":"plan"},"workspace_permissions":{"has_feature":true,"type":"plan"},"baseline":{"has_feature":true,"type":"plan"},"button_column_type":{"has_feature":true,"type":"plan"},"subtasks_column_type":{"has_feature":true,"type":"plan"},"dependency_column_type":{"has_feature":true,"type":"plan"},"dropdown_column_type":{"has_feature":true,"type":"plan"},"integration_column_type":{"has_feature":true,"type":"plan"},"group_column_type":{"has_feature":true,"type":"plan"},"multiple_person_column_type":{"has_feature":true,"type":"plan"},"email_column_type":{"has_feature":true,"type":"plan"},"lookup_column_type":{"has_feature":true,"type":"plan"},"board_relation_column_type":{"has_feature":true,"type":"plan"},"file_column_type":{"has_feature":true,"type":"plan"},"name_column_type":{"has_feature":true,"type":"plan"},"hour_column_type":{"has_feature":true,"type":"plan"},"formula_column_type":{"has_feature":true,"type":"plan"},"text_column_type":{"has_feature":true,"type":"plan"},"person_column_type":{"has_feature":true,"type":"plan"},"color_column_type":{"has_feature":true,"type":"plan"},"numeric_column_type":{"has_feature":true,"type":"plan"},"color_picker_column_type":{"has_feature":true,"type":"plan"},"timerange_column_type":{"has_feature":true,"type":"plan"},"date_column_type":{"has_feature":true,"type":"plan"},"brauer_column_type":{"has_feature":true,"type":"plan"},"pulse_log_column_type":{"has_feature":true,"type":"plan"},"pulse_updated_column_type":{"has_feature":true,"type":"plan"},"timezone_column_type":{"has_feature":true,"type":"plan"},"country_column_type":{"has_feature":true,"type":"plan"},"location_column_type":{"has_feature":true,"type":"plan"},"pulse_id_column_type":{"has_feature":true,"type":"plan"},"link_column_type":{"has_feature":true,"type":"plan"},"columns_battery_column_type":{"has_feature":true,"type":"plan"},"week_column_type":{"has_feature":true,"type":"plan"},"votes_column_type":{"has_feature":true,"type":"plan"},"duration_column_type":{"has_feature":true,"type":"plan"},"long_text_column_type":{"has_feature":true,"type":"plan"},"custom_url_column_type":{"has_feature":true,"type":"plan"},"action_column_type":{"has_feature":true,"type":"plan"},"rating_column_type":{"has_feature":true,"type":"plan"},"boolean_column_type":{"has_feature":true,"type":"plan"},"autonumber_column_type":{"has_feature":true,"type":"plan"},"phone_column_type":{"has_feature":true,"type":"plan"},"team_column_type":{"has_feature":true,"type":"plan"},"form_board_view":{"has_feature":true,"type":"plan"},"calendar_board_view":{"has_feature":true,"type":"plan"},"files_board_view":{"has_feature":true,"type":"plan"},"graph_board_view":{"has_feature":true,"type":"plan"},"kanban_board_view":{"has_feature":true,"type":"plan"},"gallery_card_view":{"has_feature":true,"type":"plan"},"map_board_view":{"has_feature":true,"type":"plan"},"spp_board_view":{"has_feature":true,"type":"plan"},"timeline_board_view":{"has_feature":true,"type":"plan"},"timeline_gantt_board_view":{"has_feature":true,"type":"plan"},"resource_allocation_board_view":{"has_feature":true,"type":"plan"},"app_feature_board_view":{"has_feature":true,"type":"plan"},"app_feature_item_view":{"has_feature":true,"type":"plan"},"table_board_view":{"has_feature":true,"type":"plan"},"layout_container_item_view":{"has_feature":true,"type":"plan"},"deadline_date_status_combo_type":{"has_feature":true,"type":"plan"},"deadline_timeline_status_combo_type":{"has_feature":true,"type":"plan"},"hipaa_compliance_activation":{"has_feature":true,"type":"plan"},"portfolio_overview_section":{"has_feature":true,"type":"plan"},"embedded_item_view":{"has_feature":false},"grid_recycler":{"has_feature":false},"automations_mirror_columns_support":{"has_feature":false},"prevent_posts_aggregation":{"has_feature":false},"alpha_addicts":{"has_feature":false},"prevent_timeline_name_cutoff":{"has_feature":false},"prevent_timeline_sticky_name":{"has_feature":false},"prevent_user_guidance":{"has_feature":false},"unlimited_storage":{"has_feature":false},"mobile_bug_reporting":{"has_feature":false},"automations_beta_recipes":{"has_feature":false},"board_temp_translation":{"has_feature":false},"ignore_unsupported_browser_message":{"has_feature":false},"pulse_page_with_values":{"has_feature":false},"asana_beta_import":{"has_feature":false},"floating_boards_ownership":{"has_feature":false},"export_board_to_excel_async":{"has_feature":false},"export_to_excel_hide_powered_by_monday":{"has_feature":false},"prevent_done_holiday_animation":{"has_feature":false},"prevent_done_animation":{"has_feature":false},"widget_excel_link":{"has_feature":false},"date_picker_enable_week_number":{"has_feature":false},"exclude_from_ab_tests":{"has_feature":false},"conditional_formatting_settings_release":{"has_feature":false},"allow_group_column":{"has_feature":false},"board_rule_based_filtering":{"has_feature":false},"board_header_v2":{"has_feature":false},"overview_section_extra_boards":{"has_feature":false},"overview_section_extra_enterprise_boards":{"has_feature":false},"disable_inbox_cards":{"has_feature":false},"import_from_xls_higher_limit":{"has_feature":false},"fs_bugs_recording":{"has_feature":false},"unlimited_daily_invites":{"has_feature":false},"prevent_failed_login_admins_email":{"has_feature":false},"shorter_session_timeouts":{"has_feature":false},"prevent_notifications_loop":{"has_feature":false},"new_first_board_creation_options":{"has_feature":false},"prevent_email_update":{"has_feature":false},"prevent_quick_filter_counters":{"has_feature":false},"unified_boards_list_show_only_my_empty_folders":{"has_feature":false},"duplicate_boards_between_accounts":{"has_feature":false},"prevent_advanced_stats":{"has_feature":false},"guest_allow_same_auth_domain":{"has_feature":false},"guest_block_same_auth_domain":{"has_feature":false},"monday_board_and_admin_cross_account":{"has_feature":false},"monday_apps_use":{"has_feature":false},"share_views":{"has_feature":false},"prevent_share_views":{"has_feature":false},"favorites_folders":{"has_feature":false},"done_party":{"has_feature":false},"file_versioning":{"has_feature":false},"block_non_admin_guests_invite":{"has_feature":false},"automations_beta_app_salesforce":{"has_feature":false},"automations_beta_app_jiraOnPremise":{"has_feature":false},"leftpane_alphabetical_sort":{"has_feature":false},"performance_measurements":{"has_feature":false},"always_prevent_plan_enforcer":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"multi_board_linked_items":{"has_feature":false},"multi_board_linkage":{"has_feature":false},"undo_move_items":{"has_feature":false},"board_toolbar_compact_menu":{"has_feature":false},"google_drive_limited_scope":{"has_feature":false},"disable_end_of_year_feature_2020":{"has_feature":false},"collapsed_group_footers":{"has_feature":false},"board_footers":{"has_feature":false},"move_to_paypal":{"has_feature":false},"prevent_automations_assign_notifications":{"has_feature":false},"multiple_status_battery":{"has_feature":false},"force_paypal_confirmation":{"has_feature":false},"new_prices":{"has_feature":false},"new_rounded_prices":{"has_feature":false},"prorated_seats_upgrade":{"has_feature":false},"prorated_upgrade_via_ui":{"has_feature":false},"application_themes":{"has_feature":false},"countdown_widget_with_board_data":{"has_feature":false},"board_conference_video":{"has_feature":false},"hide_zoom_button":{"has_feature":false},"hide_integrations_button_logos":{"has_feature":false},"my_focus":{"has_feature":false},"create_new_saml_users_as_viewers":{"has_feature":false},"monday_restricted_apps":{"has_feature":false},"mobile_payment":{"has_feature":false},"board_subset_many_columns_fix":{"has_feature":false},"support_sub_items_in_dashboards":{"has_feature":false},"invite_with_credits":{"has_feature":false},"freeze_short_interval":{"has_feature":false},"item_views":{"has_feature":false},"timeline_right_click_menu":{"has_feature":false},"workload_horizontal_workflow":{"has_feature":false},"monday_app_296":{"has_feature":false},"monday_app_567":{"has_feature":false},"monday_app_482":{"has_feature":false},"monday_app_552":{"has_feature":false},"duplicate_integrations":{"has_feature":false},"monday_solutions_tab":{"has_feature":false},"solutions_onboarding_tab":{"has_feature":false},"solutions_sharing_tab":{"has_feature":false},"workspaces_dropdown_navigation":{"has_feature":false},"workspaces_dropdown_navigation_without_pane":{"has_feature":false},"allow_non_admin_store_app_install":{"has_feature":false},"activity_log_new_jwt":{"has_feature":false},"disable_info_box":{"has_feature":false},"enable_info_box":{"has_feature":false},"clusters_for_locale":{"has_feature":false},"end_of_year_feature_2020_share_disable":{"has_feature":false},"increase_board_items_max_board_items_count_graphql":{"has_feature":false},"increase_column_limits_by_100":{"has_feature":false},"increase_column_limits_by_200":{"has_feature":false},"increase_row_limits_by_10k":{"has_feature":false},"increase_row_limits_by_20k":{"has_feature":false},"custom_recipes_increased_max_actions":{"has_feature":false},"hide_user_management_last_active":{"has_feature":false},"my_monday_mobile":{"has_feature":false},"disable_new_pdf_reader":{"has_feature":false},"disable_request_app_install":{"has_feature":false},"show_homepage_desktop":{"has_feature":false},"block_billing_ability":{"has_feature":false},"disable_hover_thumbnail_for_external_files_services":{"has_feature":false},"trial_unlimited_actions":{"has_feature":false},"salesforce_standard_entities_polling":{"has_feature":false},"gmail_integration_block":{"has_feature":false},"outlook_integration_block":{"has_feature":false},"regenerate_tokens":{"has_feature":false},"object_app_feature":{"has_feature":false},"end_of_year_feature":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"bolt_switch_in_boards_list":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"indexed_db_api_cache_edge_electron":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"unlimited_free_users_modal":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"sync_to_column_values_ms":{"has_feature":true,"type":"granted","reason":null,"due_date":null},"integrity_column_values_from_ms":{"has_feature":true,"type":"granted","reason":null,"due_date":null}},"account_id":3575423}';
        // return get('/exposed_partners/get_features/' + pulseAccountId);
    }

    public static String setAccountFreeUsers(String pulseAccountId, Integer freeUsers, string untilDate){
        Map<String, String> mapName = new Map<String, String>();
        mapName.put('free_users', String.valueOf(freeUsers));
        mapName.put('due_date', untilDate);

        return put('/salesforce_api/account/' + pulseAccountId + '/free_users', mapName);
    }

    public static String resetAccountTrial(String pulseAccountId){
        Map<String, String> mapName = new Map<String, String>();
        return put('/salesforce_api/account/' + pulseAccountId + '/reset_trial');
    }

    private static string get(String url) {
        HttpResponse response = makeRequest('GET', url);
        return response.getBody();
    }

    public static string put(String url, Map<String, String> params) {
        HttpResponse response = makeRequest('PUT', url, params);
        return response.getBody();
    }

    public static string put(String url) {
        HttpResponse response = makeRequest('PUT', url);
        return response.getBody();
    }

    private static HttpResponse makeRequest(String method, String url, Map<String, String> params){
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        setRequestHeaders(request, method, url);
        request.setBody(JSON.serialize(params));
        HttpResponse response = http.send(request);
        
        if (response.getStatusCode() != 200) {
            throw new AuraHandledException(response.getBody());
        }

        return response;
    }

    private static HttpResponse makeRequest(String method, String url){
        Http http = new Http();
        HttpRequest request = new HttpRequest();
        setRequestHeaders(request, method, url);
        HttpResponse response = http.send(request);
        
        if (response.getStatusCode() != 200) {
            throw new AuraHandledException(response.getBody());
        }

        return response;
    }

    private static void setRequestHeaders(HttpRequest request, String method, String url){
        Webhook_Key__mdt whMTD = [select id,Key__c from Webhook_Key__mdt where DeveloperName='Big_Brain'][0];
        String baseUrl = ConfigManager.getBigBrainBaseUrl();

        request.setMethod(method);
        request.setEndpoint(baseUrl + url);
        request.setHeader('Content-Type', 'application/json;charset=UTF-8');
        request.setHeader('Authorization', whMTD.Key__c);
        request.setHeader('From', UserInfo.getUserEmail());
    }
}
