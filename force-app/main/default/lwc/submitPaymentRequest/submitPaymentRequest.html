<template>
    <lightning-card if:true={cardTitle} title={cardTitle} icon-name={headerIconName}>
        <template if:true={allowSubmit}>
            <lightning-button label={submitButtonLabel} onclick={onSubmitClick} slot="actions" class="slds-m-left_x-small"></lightning-button>
        </template>
        <template if:true={showViewBreakdownBtn}>
            <lightning-button label="View Breakdown" onclick={onViewBreakdownClick} slot="actions" class="slds-m-left_x-small"></lightning-button>
        </template>
        <template if:true={headerCardText}>
            <p class="slds-m-left_medium slds-text-color_weak"><i>{headerCardText}</i></p>
        </template>
    </lightning-card>
    <!-- MODAL - CREATE NEW -->
    <lightning-card if:true={showModal}>
        <div class="slds-container_small">
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-modal_large">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Submit Payment Request</h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_large modalBody" id="modal-content-id-1">
                        <template if:true={isLoading}>
                            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
                        </template>
                        <template if:true={monthScreen}>
                            <template if:true={monthsList}>
                                <div style="height: 300px">
                                    <h2 class="slds-text-heading_small slds-text-color_weak slds-m-bottom_medium">Welcome {userFullName}!</h2>
                                    <lightning-combobox
                                        name="monthsSelection"
                                        label="Please select a month"
                                        value={monthValue}
                                        placeholder="Please select a month"
                                        options={monthsList}
                                        onchange={handleMonthChange} ></lightning-combobox>
                                </div>
                            </template>
                        </template>
                        <template if:true={data}>
                            <template if:true={dataScreen}>
                                <div class="slds-m-bottom_medium">
                                    <div class="c-container">
                                        <lightning-layout>
                                            <lightning-layout-item size="7">
                                                <div class="slds-p-right_medium">
                                                    <div class="custom-box slds-box slds-p-around_medium">
                                                        <p class="slds-text-heading_small">
                                                            <lightning-icon class="slds-m-right_small" icon-name="custom:custom17" alternative-text="Your Commission Details" title="Your Commission Details"></lightning-icon>
                                                            Your Commission Details for {selectedMonth}
                                                        </p>
                                                        <div class="slds-m-top_x-small slds-border_bottom"></div>
                                                        <div class="slds-m-top_medium">
                                                            <lightning-tile>
                                                                <dl class="slds-dl_horizontal">
                                                                    <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                        <p class="slds-truncate">Commission Amount for Monthly Deals:</p>
                                                                    </dt>
                                                                    <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                        <p class="slds-truncate">
                                                                            <lightning-formatted-number value={monthlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                        </p>
                                                                    </dd>
                                                                    <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                        <p class="slds-truncate">Commission Amount for Yearly Deals:</p>
                                                                    </dt>
                                                                    <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                        <p class="slds-truncate">
                                                                            <lightning-formatted-number value={yearlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                        </p>
                                                                    </dd>
                                                                    <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                        <p class="slds-truncate">Commission Amount for Two Yearly Deals:</p>
                                                                    </dt>
                                                                    <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                        <p class="slds-truncate">
                                                                            <lightning-formatted-number value={twoYearlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                        </p>
                                                                    </dd>
                                                                </dl>
                                                            </lightning-tile>
                                                            <div class="slds-m-top_medium ">
                                                                <lightning-tile>
                                                                    <dl class="slds-dl_horizontal">
                                                                        <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                            <p class="slds-truncate slds-text-title_bold">Total Commission Amount:</p>
                                                                        </dt>
                                                                        <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                            <p class="slds-truncate slds-text-title_bold">
                                                                                <lightning-formatted-number value={totalAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                            </p>
                                                                        </dd>
                                                                    </dl>
                                                                </lightning-tile>
                                                            </div> 
                                                        </div>
                                                    </div>
                                                </div>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="5">
                                                <div class="custom-box slds-box slds-p-around_medium" style="height: 100%;" >
                                                    <p class="slds-text-heading_small"><lightning-icon  class="slds-m-right_small" icon-name="standard:promotions" alternative-text="Your Commission Model" title="Your Commission Model"></lightning-icon>
                                                        Your Commission Model
                                                    </p>
                                                    <div class="slds-m-top_x-small slds-border_bottom"></div>
                                                    <div class="slds-m-top_medium">
                                                        <lightning-tile>
                                                            <dl class="slds-dl_horizontal">
                                                                <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                    <p>Inbound:</p>
                                                                </dt>
                                                                <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                    <p class="slds-truncate">
                                                                        <lightning-formatted-number value={inboundPercent} format-style="percent"></lightning-formatted-number>
                                                                    </p>
                                                                </dd>
                                                                <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                    <p>Outbound:</p>
                                                                </dt>
                                                                <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                    <p class="slds-truncate">
                                                                        <lightning-formatted-number value={outboundPercent} format-style="percent"></lightning-formatted-number>
                                                                    </p>
                                                                </dd>
                                                            </dl>
                                                        </lightning-tile>
                                                    </div>
                                                </div>
                                                
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </div>
                                </div>
                                <div class="custom-box slds-box slds-p-around_medium">
                                    <lightning-layout>
                                        <lightning-layout-item size="5">
                                            <p class="slds-text-heading_small">
                                                <lightning-icon class="slds-m-right_small" icon-name="doctype:csv" alternative-text="Your Commission Details" title="Your Commission Details"></lightning-icon>
                                                Your Detailed Commission Report
                                            </p>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="3">
                                            <c-datatable-search all-data={_allData} onfiltered={handleResults}></c-datatable-search>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="4">
                                            <lightning-button icon-name="utility:download" 
                                                label="Download as CSV" 
                                                title="Download CSV File"
                                                onclick={downloadCSVFile} 
                                                variant="neutral"
                                                class="slds-float_right">
                                            </lightning-button>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                    <div class="slds-m-top_x-small slds-border_bottom"></div>
                                    <lightning-datatable
                                        data={data}
                                        columns={columns}
                                        hide-checkbox-column
                                        key-field="Id"
                                        min-column-width="140"
                                        default-sort-direction={defaultSortDirection}
                                        sorted-direction={sortDirection}
                                        sorted-by={sortedBy}
                                        onsort={onHandleSort}
                                        show-row-number-column>
                                    </lightning-datatable>
                                    </br>
                                    <lightning-layout horizontal-align="space">
                                        <lightning-layout-item flexibility="auto">
                                            <lightning-button label="Previous" icon-name="utility:chevronleft" onclick={previousHandler}>
                                            </lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item flexibility="auto">
                                            Page {page} of {totalPage}
                                        </lightning-layout-item>
                                        <lightning-layout-item flexibility="auto">
                                            <lightning-button label="Next" icon-name="utility:chevronright" icon-position="right"
                                                onclick={nextHandler}></lightning-button>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </div>
                            </template>
                            <template if:true={filesScreen}>
                                <p>In order to get the payment for {selectedMonth} commission, please update your invoice here:</p>
                                <c-file-upload-improved allow-multiple accepted-formats=".pdf,.docx,.png,.jpeg" session-key={newPaymentRequestId} record-id={newPaymentRequestId} required community></c-file-upload-improved>
                                <lightning-layout>
                                    <lightning-layout-item size="6">
                                        <lightning-input type="number" name="mdf" label="MDF Amount $" formatter="currency" value={mdfAmount} onchange={handleMdfAmountChange}></lightning-input>
                                    </lightning-layout-item>
                                </lightning-layout>
                                <lightning-layout>
                                    <lightning-layout-item size="6">
                                        <lightning-input type="number" name="mdf" label="MDF Amount $" formatter="currency" value={spiffAmount} onchange={handleSpiffAmountChange}></lightning-input>
                                    </lightning-layout-item>
                                </lightning-layout>  
                                <p class="slds-p-top_medium">By Submitting the request you confirm that your commission invoice matches the numbers populated in monday.com’s commission report. Any issues with specific deal not appearing in the report should be reported here.</br>Please note, changes will be reconciled in the following month’s commission report.</br>Our commission payment terms are net 45.</p>                              
                                <p class="slds-p-top_medium">If you don't have the invoice prepared yet, please click on Save As Draft and come back later to upload the invoice and submit.</p>
                            </template>
                            <template if:true={submittedScreen}>
                                <p class="slds-text-color_success slds-align_absolute-center">{submittedScreenTitle}</p>
                                <template if:false={recordId}>
                                    <a class="slds-align_absolute-center" href={paymentRequestLink} target="_blank">Link to Payment Request</a>
                                </template>
                                <p class="slds-align_absolute-center">{submittedScreenText}</p>
                            </template>
                        </template>
                        <template if:true={customError}>
                            <div class="slds-var-m-vertical_small">
                                <span class="slds-text-color_destructive">{customError}</span>
                            </div>
                            <template if:true={monthScreen}>
                                <template if:true={paymentRequestLink}>
                                    <a href={paymentRequestLink} target="_blank">Link to Payment Request</a>
                                </template>
                            </template>
                        </template>
                        
                    </div>
                    <footer class="slds-modal__footer">
                        <template if:true={error}>
                            <c-error-panel errors={error}></c-error-panel>
                        </template>
                        <template if:true={showCancelButton}>
                            <lightning-button variant="neutral" name="cancel" label="Cancel" title="Cancel" onclick={handleCancelClick} class="slds-m-left_x-small"></lightning-button>
                        </template>
                        <template if:true={monthScreen}>
                            <lightning-button variant="brand" name="nextFromMonthsScreen" label="Next" title="Next" onclick={loadDataScreen} class="slds-m-left_x-small" ></lightning-button>
                        </template>
                        <template if:true={dataScreen}>
                            <template if:false={viewBreakdownMode}>
                                <lightning-button variant="brand" name="nextFromDataScreen" label="Next" title="Next" onclick={loadFilesScreen} class="slds-m-left_x-small" ></lightning-button>
                            </template>
                        </template>
                        <template if:true={filesScreen}>
                            <lightning-button variant="neutral" name="prev" label="Previous" title="Previous" onclick={goBackToDataScreen} class="slds-m-left_x-small" ></lightning-button>
                            <template if:false={recordId}>
                                <lightning-button variant="neutral" name="saveAsDraft" label="Save As Draft" title="Save As Draft" onclick={saveAsDraft} class="slds-m-left_x-small" ></lightning-button>
                            </template>
                            <lightning-button variant="brand" name="submit" label="Submit" title="Submit" onclick={submitPaymentRequestForApproval} class="slds-m-left_x-small" ></lightning-button>
                        </template>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>
    </lightning-card>
</template>