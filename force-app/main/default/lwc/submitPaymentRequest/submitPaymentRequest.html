<template>
    <lightning-card title="New Payment Request" icon-name="custom:custom17">
        <lightning-button label="Submit" onclick={loadMonthsPicklist} slot="actions"></lightning-button>
        <lightning-card if:true={showModal}>
            <div class="slds-container_small">
                <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-modal_medium">
                    <div class="slds-modal__container">
                        <header class="slds-modal__header">
                            <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">New Payment Request</h2>
                        </header>
                        <div class="slds-modal__content slds-p-around_large" id="modal-content-id-1">
                            <template if:true={monthScreen}>
                                <h2 class="slds-text-heading_small slds-text-color_weak slds-m-bottom_medium">Welcome {userFullName}!</h2>
                                <lightning-combobox
                                    name="monthsSelection"
                                    label="Please select a month"
                                    value={monthValue}
                                    placeholder="Please select a month"
                                    options={monthsList}
                                    onchange={handleMonthChange} ></lightning-combobox>
                            </template>
                            <template if:true={data}>
                                <template if:true={dataScreen}>
                                    <div class="slds-m-bottom_medium">
                                        <div class="c-container">
                                            <lightning-layout>
                                                <lightning-layout-item size="7">
                                                    <div class="slds-p-right_medium">
                                                        <div class="custom-box slds-box slds-p-around_medium">
                                                            <p class="slds-text-heading_small">
                                                                <lightning-icon class="slds-m-right_small" icon-name="custom:custom17" alternative-text="Your Commission Details" title="Your Commission Details"></lightning-icon>
                                                                Your Commission Details for {selectedMonth}
                                                            </p>
                                                            <div class="slds-m-top_x-small slds-border_bottom"></div>
                                                            <div class="slds-m-top_medium">
                                                                <lightning-tile>
                                                                    <dl class="slds-dl_horizontal">
                                                                        <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                            <p class="slds-truncate">Monthly Commission Amount:</p>
                                                                        </dt>
                                                                        <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                            <p class="slds-truncate">
                                                                                <lightning-formatted-number value={monthlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                            </p>
                                                                        </dd>
                                                                        <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                            <p class="slds-truncate">Yearly Commission Amount:</p>
                                                                        </dt>
                                                                        <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                            <p class="slds-truncate">
                                                                                <lightning-formatted-number value={yearlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                            </p>
                                                                        </dd>
                                                                        <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                            <p class="slds-truncate">Two Yearly Commission Amount:</p>
                                                                        </dt>
                                                                        <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                            <p class="slds-truncate">
                                                                                <lightning-formatted-number value={twoYearlyAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                            </p>
                                                                        </dd>
                                                                    </dl>
                                                                </lightning-tile>
                                                                <div class="slds-m-top_medium ">
                                                                    <lightning-tile>
                                                                        <dl class="slds-dl_horizontal">
                                                                            <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                                <p class="slds-truncate slds-text-title_bold">Total Commission Amount:</p>
                                                                            </dt>
                                                                            <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                                <p class="slds-truncate slds-text-title_bold">
                                                                                    <lightning-formatted-number value={totalAmount} format-style="currency" currency-code="USD" currency-display-as="code"></lightning-formatted-number>
                                                                                </p>
                                                                            </dd>
                                                                        </dl>
                                                                    </lightning-tile>
                                                                </div> 
                                                            </div>
                                                        </div>
                                                    </div>
                                                </lightning-layout-item>
                                                <lightning-layout-item size="5">
                                                    <div class="custom-box slds-box slds-p-around_medium" style="height: 100%;" >
                                                        <p class="slds-text-heading_small"><lightning-icon  class="slds-m-right_small" icon-name="standard:promotions" alternative-text="Your Commission Model" title="Your Commission Model"></lightning-icon>
                                                            Your Commission Model
                                                        </p>
                                                        <div class="slds-m-top_x-small slds-border_bottom"></div>
                                                        <div class="slds-m-top_medium">
                                                            <lightning-tile>
                                                                <dl class="slds-dl_horizontal">
                                                                    <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                        <p>Inbound:</p>
                                                                    </dt>
                                                                    <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                        <p class="slds-truncate">
                                                                            <lightning-formatted-number value={inboundPercent} format-style="percent"></lightning-formatted-number>
                                                                        </p>
                                                                    </dd>
                                                                    <dt class="slds-dl_horizontal__label" style="width: 70%;">
                                                                        <p>Outbound:</p>
                                                                    </dt>
                                                                    <dd class="slds-dl_horizontal__detail slds-tile__meta" style="width: 30%;">
                                                                        <p class="slds-truncate">
                                                                            <lightning-formatted-number value={outboundPercent} format-style="percent"></lightning-formatted-number>
                                                                        </p>
                                                                    </dd>
                                                                </dl>
                                                            </lightning-tile>
                                                        </div>
                                                    </div>
                                                    
                                                </lightning-layout-item>
                                            </lightning-layout>
                                        </div>
                                    </div>
                                    <div class="custom-box slds-box slds-p-around_medium">
                                        <p class="slds-text-heading_small">
                                            <lightning-icon class="slds-m-right_small" icon-name="doctype:csv" alternative-text="Your Commission Details" title="Your Commission Details"></lightning-icon>
                                            Your Detailed Commission Report
                                        </p>
                                        <div class="slds-m-top_x-small slds-border_bottom"></div>
                                        <lightning-datatable
                                            data={data}
                                            columns={columns}
                                            hide-checkbox-column="true"
                                            key-field="id"
                                            column-widths-mode="auto">
                                        </lightning-datatable>
                                        <div class="-inverse slds-m-top_medium">
                                            <p>Do you want to download data in a CSV format? Click Here &nbsp;
                                                <lightning-button icon-name="utility:download" 
                                                                label="Download as CSV" 
                                                                title="Download CSV File"
                                                                onclick={downloadCSVFile} variant="brand"></lightning-button>
                                            </p>
                                        </div>
                                    </div>
                                </template>
                                <template if:true={filesScreen}>
                                    <p class="slds-truncate">In order to get the payment for {selectedMonth} commission, please update your invoice here:</p>
                                    <lightning-file-upload
                                            label="Upload Files"
                                            name="fileUploader"
                                            accept={acceptedFormats}
                                            record-id={newPaymentRequestId}
                                            onuploadfinished={handleUploadFinished}>
                                    </lightning-file-upload>
                                    <template if:true={fileId}><p class="slds-truncate">No. of files uploaded : 1</p></template>
                                    <p class="slds-truncate">If you don't have the invoice prepared yet, please click on Save As Draft and come back later to upload the invoice and submit.</p>
                                </template>
                                <template if:true={submittedScreen}>
                                    <p class="slds-truncate">Payment Request Created Successfully!</p>
                                    <a href={paymentRequestLink} target="_blank">Link to Payment Request</a>
                                    <p class="slds-truncate">{submittedScreenText}</p>
                                </template>
                            </template>
                            <template if:true={customError}>
                                <div class="slds-var-m-vertical_small">
                                    <span class="slds-text-color_destructive">{customError}</span>
                                </div>
                                <template if:true={paymentRequestLink}>
                                    <a href={paymentRequestLink} target="_blank">Link to Payment Request</a>
                                </template>
                            </template>
                            <template if:true={error}>
                                <c-error-panel errors={error}></c-error-panel>
                            </template>
                        </div>
                        <footer class="slds-modal__footer">
                            <template if:true={monthScreen}>
                                <lightning-button variant="neutral" name="cancel" label="Cancel" title="Cancel" onclick={handleCancelClick} class="slds-m-left_x-small"></lightning-button>
                                <lightning-button variant="brand" name="nextFromMonthsScreen" label="Next" title="Next" onclick={loadDataScreen} class="slds-m-left_x-small" ></lightning-button>
                            </template>
                            <template if:true={dataScreen}>
                                <lightning-button variant="neutral" name="cancel" label="Cancel" title="Cancel" onclick={handleCancelClick} class="slds-m-left_x-small"></lightning-button>
                                <lightning-button variant="neutral" name="prevFromDataScreen" label="Previous" title="Previous" onclick={goBackToMonthScreen} class="slds-m-left_x-small" ></lightning-button>
                                <lightning-button variant="brand" name="nextFromDataScreen" label="Next" title="Next" onclick={loadFilesScreen} class="slds-m-left_x-small" ></lightning-button>
                            </template>
                            <template if:true={filesScreen}>
                                <lightning-button variant="neutral" name="cancel" label="Cancel" title="Cancel" onclick={handleCancelClick} class="slds-m-left_x-small"></lightning-button>
                                <lightning-button variant="neutral" name="prev" label="Previous" title="Previous" onclick={goBackToDataScreen} class="slds-m-left_x-small" ></lightning-button>
                                <lightning-button variant="neutral" name="saveAsDraft" label="Save As Draft" title="Save As Draft" onclick={createNewPaymentRequest} class="slds-m-left_x-small" ></lightning-button>
                                <lightning-button variant="brand" name="submit" label="Submit" title="Submit" onclick={createNewPaymentRequest} class="slds-m-left_x-small" ></lightning-button>
                            </template>
                            <template if:true={submittedScreen}>
                                <lightning-button variant="neutral" name="ok" label="OK" title="OK" onclick={handleCancelClick} class="slds-m-left_x-small"></lightning-button>
                            </template>
                        </footer>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </div>
        </lightning-card>
    </lightning-card>
</template>